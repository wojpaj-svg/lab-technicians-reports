<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Technician report</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f5f7fb;margin:0;padding:18px;color:#111827}
    .card{max-width:980px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px 14px 18px}
    h1{font-size:18px;margin:0 0 10px}

    /* poprawione odstępy i szerokości (żeby daty nie nachodziły) */
    .row{display:grid;grid-template-columns: 1fr 180px 180px auto;gap:14px;align-items:end}
    @media (max-width: 760px){
      .row{grid-template-columns: 1fr; gap:10px}
    }

    label{font-size:12px;color:#6b7280;display:block;margin-bottom:4px}
    select,input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:13px;background:#fff}
    input[type="date"]{padding:7px 10px}

    button{padding:9px 14px;border-radius:999px;border:0;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}

    .muted{color:#6b7280;font-size:12px;margin-top:10px}
    .result{margin-top:14px;border-top:1px solid #e5e7eb;padding-top:12px}
    .total{font-weight:700}
    .toolbar{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
    .btn2{background:#e5e7eb;color:#111827}

    .item{padding:10px 12px;margin-top:8px;border-radius:10px;background:#eef3ff}
    .small{font-size:12px;color:#6b7280}
    .late{color:#b91c1c !important;font-weight:700}
    .summaryRow{display:flex;justify-content:space-between;gap:12px;padding:10px 12px;margin-top:8px;border-radius:10px;background:#f3f4f6}
    .mono{font-variant-numeric: tabular-nums}
  </style>
</head>

<body>
  <div class="card">
    <h1>Technician report</h1>

    <div class="row">
      <div>
        <label>Technician</label>
        <select id="tech">
          <option value="__ALL__">All technicians</option>
          <option value="Sasi">Sasi</option>
          <option value="Viviana">Viviana</option>
          <option value="Lara">Lara</option>
          <option value="Klara">Klara</option>
          <option value="Simon">Simon</option>
        </select>
      </div>
      <div>
        <label>Date from</label>
        <input id="from" type="date" />
      </div>
      <div>
        <label>Date to</label>
        <input id="to" type="date" />
      </div>
      <div>
        <button id="gen">Generate</button>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn2" id="csv" disabled>Export CSV</button>
      <button class="btn2" id="print" disabled>Print</button>
    </div>

    <div class="muted" id="msg">Ready.</div>

    <div class="result" id="out" style="display:none">
      <div class="total" id="total"></div>
      <div id="days"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBz9WjF4aUhrCujzpzn4DHGX1MW--sV7iQ",
      authDomain: "lab-technicians-booking.firebaseapp.com",
      projectId: "lab-technicians-booking",
      storageBucket: "lab-technicians-booking.firebasestorage.app",
      messagingSenderId: "897254183022",
      appId: "1:897254183022:web:5ed0e7b98fa5553717967f",
      measurementId: "G-ZF5Z2GLBK7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await signInAnonymously(auth);

    const db = getFirestore(app);
    const bookingsCol = collection(db, "bookings");

    const techEl = document.getElementById("tech");
    const fromEl = document.getElementById("from");
    const toEl = document.getElementById("to");
    const genBtn = document.getElementById("gen");
    const msgEl = document.getElementById("msg");
    const outEl = document.getElementById("out");
    const totalEl = document.getElementById("total");
    const daysEl = document.getElementById("days");
    const csvBtn = document.getElementById("csv");
    const printBtn = document.getElementById("print");

    let lastMode = "single"; // "single" | "all"
    let lastRows = [];
    let lastSummary = [];

    // default: current month
    const now = new Date();
    const first = new Date(now.getFullYear(), now.getMonth(), 1);
    const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    fromEl.value = first.toISOString().slice(0,10);
    toEl.value = last.toISOString().slice(0,10);

    function hoursBetween(a, b){
      return (b - a) / (1000 * 60 * 60);
    }

    function toJsDateMaybe(ts){
      if (!ts) return null;
      if (ts instanceof Date) return ts;
      if (typeof ts?.toDate === "function") return ts.toDate(); // Firestore Timestamp
      return null;
    }

    // porównanie "czy utworzone po dniu startu" (ignorujemy godzinę)
    function isCreatedLate(createdAt, startDate){
      if (!createdAt || !startDate) return false;
      const c = new Date(createdAt.getFullYear(), createdAt.getMonth(), createdAt.getDate());
      const s = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
      return c.getTime() > s.getTime();
    }

    genBtn.addEventListener("click", async () => {
      try {
        msgEl.textContent = "Loading…";
        outEl.style.display = "none";
        daysEl.innerHTML = "";
        totalEl.textContent = "";
        csvBtn.disabled = true;
        printBtn.disabled = true;

        const modeTech = techEl.value;
        const from = new Date(fromEl.value + "T00:00:00");
        const to = new Date(toEl.value + "T23:59:59");

        if (modeTech === "__ALL__") {
          // ALL: jeden query po zakresie dat (bez technician filter) — nie powinno wymagać composite index
          const qAll = query(
            bookingsCol,
            where("start", ">=", Timestamp.fromDate(from)),
            where("start", "<=", Timestamp.fromDate(to)),
            orderBy("start")
          );

          const snap = await getDocs(qAll);
          const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));

          // sum hours per technician
          const map = new Map();
          rows.forEach(b => {
            const s = b.start.toDate();
            const e = b.end.toDate();
            const h = hoursBetween(s, e);
            const tech = b.technician || "(unknown)";
            map.set(tech, (map.get(tech) || 0) + h);
          });

          const summary = Array.from(map.entries())
            .map(([tech, hours]) => ({ tech, hours }))
            .sort((a,b) => a.tech.localeCompare(b.tech));

          lastMode = "all";
          lastSummary = summary;
          lastRows = rows;

          outEl.style.display = "block";
          totalEl.textContent = `All technicians — total records: ${rows.length}`;
          daysEl.innerHTML = "";

          if (!summary.length) {
            daysEl.innerHTML = '<div class="muted">No records in this range.</div>';
            msgEl.textContent = "Loaded: 0 records.";
          } else {
            summary.forEach(s => {
              const row = document.createElement("div");
              row.className = "summaryRow";
              row.innerHTML = `<div><strong>${s.tech}</strong></div><div class="mono">${s.hours.toFixed(2)} h</div>`;
              daysEl.appendChild(row);
            });
            msgEl.textContent = `Loaded: ${rows.length} records.`;
          }

          csvBtn.disabled = false;
          printBtn.disabled = false;
          return;
        }

        // SINGLE TECHNICIAN
        const tech = modeTech;

        const q = query(
          bookingsCol,
          where("technician", "==", tech),
          where("start", ">=", Timestamp.fromDate(from)),
          where("start", "<=", Timestamp.fromDate(to)),
          orderBy("start")
        );

        const snap = await getDocs(q);
        const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        lastMode = "single";
        lastRows = rows;
        lastSummary = [];

        let totalHours = 0;

        outEl.style.display = "block";
        daysEl.innerHTML = "";

        if (!rows.length) {
          totalEl.textContent = "Total hours: 0.00 h";
          daysEl.innerHTML = '<div class="muted">No records in this range.</div>';
          msgEl.textContent = "Loaded: 0 records.";
          csvBtn.disabled = false;
          printBtn.disabled = false;
          return;
        }

        rows.forEach(b => {
          const s = b.start.toDate();
          const e = b.end.toDate();
          const h = hoursBetween(s, e);
          totalHours += h;

          const createdAt = toJsDateMaybe(b.createdAt);
          const late = isCreatedLate(createdAt, s);

          const item = document.createElement("div");
          item.className = "item";

          const createdLine = createdAt
            ? `Created by: ${b.createdBy || "?"} on: ${createdAt.toLocaleString()}${late ? " (added late)" : ""}`
            : `Created by: ${b.createdBy || "?"}`;

          item.innerHTML = `
            <div><strong>${b.task || "assignment"}</strong></div>
            <div class="small">${s.toLocaleString()} → ${e.toLocaleString()} (${h.toFixed(2)} h)</div>
            <div class="small ${late ? "late" : ""}">${createdLine}</div>
          `;
          daysEl.appendChild(item);
        });

        totalEl.textContent = `Total hours: ${totalHours.toFixed(2)} h`;
        msgEl.textContent = `Loaded: ${rows.length} records.`;

        csvBtn.disabled = false;
        printBtn.disabled = false;

      } catch (err) {
        console.error(err);
        msgEl.textContent = `ERROR: ${err?.message || err}`;
      }
    });

    csvBtn.addEventListener("click", () => {
      if (lastMode === "all") {
        const header = ["technician","total_hours"];
        const lines = [header.join(",")];
        (lastSummary || []).forEach(r => {
          lines.push(`"${r.tech}","${r.hours.toFixed(2)}"`);
        });

        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `technician-report_ALL_${fromEl.value}_to_${toEl.value}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        return;
      }

      if (!lastRows.length) return;

      const header = ["technician","task","start","end","hours","createdBy","createdAt","late","id"];
      const lines = [header.join(",")];

      lastRows.forEach(b => {
        const s = b.start.toDate();
        const e = b.end.toDate();
        const h = hoursBetween(s, e);
        const createdAt = toJsDateMaybe(b.createdAt);
        const late = isCreatedLate(createdAt, s) ? "YES" : "NO";
        const createdAtStr = createdAt ? createdAt.toISOString() : "";

        const row = [
          b.technician || "",
          (b.task || "").replaceAll('"','""'),
          s.toISOString(),
          e.toISOString(),
          h.toFixed(2),
          (b.createdBy || "").replaceAll('"','""'),
          createdAtStr,
          late,
          b.id || ""
        ].map(v => `"${v}"`);

        lines.push(row.join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `technician-report_${techEl.value}_${fromEl.value}_to_${toEl.value}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    printBtn.addEventListener("click", () => window.print());
  </script>
</body>
</html>
